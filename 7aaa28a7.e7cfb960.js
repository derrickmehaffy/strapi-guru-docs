(window.webpackJsonp=window.webpackJsonp||[]).push([[16],{86:function(e,t,a){"use strict";a.r(t),a.d(t,"frontMatter",(function(){return l})),a.d(t,"metadata",(function(){return o})),a.d(t,"toc",(function(){return s})),a.d(t,"default",(function(){return c}));var n=a(3),r=a(7),i=(a(0),a(99)),l={id:"do-ansible",title:"DigitalOcean Ansible Guide",sidebar_label:"Ansible Guide"},o={unversionedId:"deploy-guides/do/do-ansible",id:"deploy-guides/do/do-ansible",isDocsHomePage:!1,title:"DigitalOcean Ansible Guide",description:"Ansible playbooks breakdown",source:"@site/docs/deploy-guides/do/do-ansible.md",slug:"/deploy-guides/do/do-ansible",permalink:"/deploy-guides/do/do-ansible",editUrl:"https://github.com/derrickmehaffy/strapi-guru-docs/edit/main/docs/deploy-guides/do/do-ansible.md",version:"current",sidebar_label:"Ansible Guide",sidebar:"docSidebar",previous:{title:"DigitalOcean Terraform Guide",permalink:"/deploy-guides/do/do-terraform"},next:{title:"GCP Deploy",permalink:"/deploy-guides/gcp/gcp-intro"}},s=[{value:"Ansible playbooks breakdown",id:"ansible-playbooks-breakdown",children:[{value:"main.yml",id:"mainyml",children:[]},{value:"playbooks/strapi_database.yml",id:"playbooksstrapi_databaseyml",children:[]},{value:"playbooks/strapi_server.yml",id:"playbooksstrapi_serveryml",children:[]},{value:"playbooks/strapi_dply.yml",id:"playbooksstrapi_dplyyml",children:[]},{value:"playbooks/strapi_rollback.yml",id:"playbooksstrapi_rollbackyml",children:[]}]},{value:"Ansible Requirements",id:"ansible-requirements",children:[]},{value:"Ansible Instructions",id:"ansible-instructions",children:[]}],b={toc:s};function c(e){var t=e.components,a=Object(r.a)(e,["components"]);return Object(i.b)("wrapper",Object(n.a)({},b,a,{components:t,mdxType:"MDXLayout"}),Object(i.b)("h2",{id:"ansible-playbooks-breakdown"},"Ansible playbooks breakdown"),Object(i.b)("p",null,"For modules used from Ansible-Galaxy / GitHub see the ",Object(i.b)("a",Object(n.a)({parentName:"p"},{href:"https://github.com/derrickmehaffy/strapi-digitalocean-deploy/blob/main/ansible/requirements.yml"}),"requirements file"),"."),Object(i.b)("p",null,"Ansible within this template does the following:"),Object(i.b)("h3",{id:"mainyml"},"main.yml"),Object(i.b)("ol",null,Object(i.b)("li",{parentName:"ol"},"Loads encrypted Variables from ",Object(i.b)("inlineCode",{parentName:"li"},"crypt_vars/all.yml")),Object(i.b)("li",{parentName:"ol"},"Loads tf_vars from Terraform via ",Object(i.b)("inlineCode",{parentName:"li"},"tf_vars/tf_vars.yml")),Object(i.b)("li",{parentName:"ol"},"Runs the Apt role to install a handful of required/useful packages"),Object(i.b)("li",{parentName:"ol"},"Sets up 3 users: root, devops, and deploy"),Object(i.b)("li",{parentName:"ol"},"Triggers the ",Object(i.b)("inlineCode",{parentName:"li"},"strapi_database.yml")," playbook")),Object(i.b)("p",null,"User definitions are as such (They all have no password set, aka disabled password):"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},"Root user => initial connection for main.yml, using defined SSH key in Terraform"),Object(i.b)("li",{parentName:"ul"},'Devops user => "Admin" sudo user you should regularly use to connect or allow team members to connect to (adjust to fit your needs) and also used for the database/strapi server setup (stop using root people)'),Object(i.b)("li",{parentName:"ul"},"Deploy user => Strapi's service user, what Strapi runs as")),Object(i.b)("div",{className:"admonition admonition-warning alert alert--danger"},Object(i.b)("div",Object(n.a)({parentName:"div"},{className:"admonition-heading"}),Object(i.b)("h5",{parentName:"div"},Object(i.b)("span",Object(n.a)({parentName:"h5"},{className:"admonition-icon"}),Object(i.b)("svg",Object(n.a)({parentName:"span"},{xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"}),Object(i.b)("path",Object(n.a)({parentName:"svg"},{fillRule:"evenodd",d:"M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"})))),"warning")),Object(i.b)("div",Object(n.a)({parentName:"div"},{className:"admonition-content"}),Object(i.b)("p",{parentName:"div"},"Deploy user does not have sudo perms, this is intended!"))),Object(i.b)("p",null,"Apt packages that are installed on both systems are:"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},"software-properties-common"),Object(i.b)("li",{parentName:"ul"},"build-essential"),Object(i.b)("li",{parentName:"ul"},"net-tools"),Object(i.b)("li",{parentName:"ul"},"zip"),Object(i.b)("li",{parentName:"ul"},"unzip")),Object(i.b)("p",null,"It will also automatically apply software updates using the ",Object(i.b)("inlineCode",{parentName:"p"},"dist")," upgrade and automatically remove packages that are no longer needed."),Object(i.b)("h3",{id:"playbooksstrapi_databaseyml"},"playbooks/strapi_database.yml"),Object(i.b)("ol",null,Object(i.b)("li",{parentName:"ol"},"Loads encrypted Variables from ",Object(i.b)("inlineCode",{parentName:"li"},"crypt_vars/database.yml")),Object(i.b)("li",{parentName:"ol"},"Loads tf_vars from Terraform via ",Object(i.b)("inlineCode",{parentName:"li"},"tf_vars/tf_vars.yml")),Object(i.b)("li",{parentName:"ol"},"Installs MariaDB v10.3"),Object(i.b)("li",{parentName:"ol"},"Creates a database for Strapi"),Object(i.b)("li",{parentName:"ol"},"Creates a user for Strapi"),Object(i.b)("li",{parentName:"ol"},"Sets user permissions on the database"),Object(i.b)("li",{parentName:"ol"},"Triggers the ",Object(i.b)("inlineCode",{parentName:"li"},"strapi_server.yml")," playbook")),Object(i.b)("p",null,"Database name and user are based on the labels you set for the DigitalOcean instances in Terraform, thus the defaults are:"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},"DB Name: my-strapi-db"),Object(i.b)("li",{parentName:"ul"},"DB User: my-strapi-admin")),Object(i.b)("p",null,"The password is stored in the ",Object(i.b)("inlineCode",{parentName:"p"},"crypt_vars/database.yml")," and this file should be encrypted (see instructions below on dealing with Ansible-Vault)"),Object(i.b)("h3",{id:"playbooksstrapi_serveryml"},"playbooks/strapi_server.yml"),Object(i.b)("ol",null,Object(i.b)("li",{parentName:"ol"},"Loads encrypted Variables from ",Object(i.b)("inlineCode",{parentName:"li"},"crypt_vars/strapi.yml")),Object(i.b)("li",{parentName:"ol"},"Loads encrypted Variables from ",Object(i.b)("inlineCode",{parentName:"li"},"crypt_vars/database.yml")),Object(i.b)("li",{parentName:"ol"},"Loads tf_vars from Terraform via ",Object(i.b)("inlineCode",{parentName:"li"},"tf_vars/tf_vars.yml")),Object(i.b)("li",{parentName:"ol"},"Installs Node via the version defined in ",Object(i.b)("inlineCode",{parentName:"li"},"group_vars/strapi.yml")," (default is v14)"),Object(i.b)("li",{parentName:"ol"},"Installs yarn"),Object(i.b)("li",{parentName:"ol"},"Installs the ",Object(i.b)("a",Object(n.a)({parentName:"li"},{href:"https://github.com/acmesh-official/acme.sh"}),"Acme.sh client")," (way better than certbot)"),Object(i.b)("li",{parentName:"ol"},"Requests Let's Encrypt SSL Cert using Cloudflare DNS-01 Verification"),Object(i.b)("li",{parentName:"ol"},"Installs Nginx, configures upstream, deploys configs for HTTP => HTTPs"),Object(i.b)("li",{parentName:"ol"},"Creates the deploy directory and various child directories ",Object(i.b)("inlineCode",{parentName:"li"},"/srv/deploy/*")),Object(i.b)("li",{parentName:"ol"},"Installs ",Object(i.b)("a",Object(n.a)({parentName:"li"},{href:"https://pm2.io/"}),"PM2")," globally"),Object(i.b)("li",{parentName:"ol"},"Sets up PM2 to be loaded on reboot and start previous services"),Object(i.b)("li",{parentName:"ol"},"Triggers the ",Object(i.b)("inlineCode",{parentName:"li"},"strapi_dply.yml")," playbook")),Object(i.b)("h3",{id:"playbooksstrapi_dplyyml"},"playbooks/strapi_dply.yml"),Object(i.b)("p",null,"First off don't ask why it's named this way, the Ansible linter I use throws errors if I use ",Object(i.b)("inlineCode",{parentName:"p"},"deploy")," and I'm lazy and don't feel like fixing it. ",Object(i.b)("inlineCode",{parentName:"p"},"\xaf\\_(\u30c4)_/\xaf")),Object(i.b)("ol",null,Object(i.b)("li",{parentName:"ol"},"Loads encrypted Variables from ",Object(i.b)("inlineCode",{parentName:"li"},"crypt_vars/strapi.yml")),Object(i.b)("li",{parentName:"ol"},"Loads encrypted Variables from ",Object(i.b)("inlineCode",{parentName:"li"},"crypt_vars/database.yml")),Object(i.b)("li",{parentName:"ol"},"Loads tf_vars from Terraform via ",Object(i.b)("inlineCode",{parentName:"li"},"tf_vars/tf_vars.yml")),Object(i.b)("li",{parentName:"ol"},"Uses the ",Object(i.b)("a",Object(n.a)({parentName:"li"},{href:"https://github.com/ansistrano/deploy"}),"ansistrano")," deployment system to version deployments and make it easier to rollback if failures happen."),Object(i.b)("li",{parentName:"ol"},"Pulls project from Git source"),Object(i.b)("li",{parentName:"ol"},"Pushes templated ",Object(i.b)("inlineCode",{parentName:"li"},".env")," and ",Object(i.b)("inlineCode",{parentName:"li"},"ecosystem.config.js")," for Strapi and PM2"),Object(i.b)("li",{parentName:"ol"},"Installs node_modules (using yarn, fuck npm)"),Object(i.b)("li",{parentName:"ol"},"Builds the Strapi Admin ",Object(i.b)("strong",{parentName:"li"},"in production mode")," (Stop deploying dev servers)"),Object(i.b)("li",{parentName:"ol"},"Starts/Reloads Strapi application")),Object(i.b)("p",null,"Eventually I want to add checking to ensure the Strapi project started correctly and do an automated DB backup. Should failures occur then it would run the rollback playbook and restore the DB from the backup."),Object(i.b)("h3",{id:"playbooksstrapi_rollbackyml"},"playbooks/strapi_rollback.yml"),Object(i.b)("div",{className:"admonition admonition-info alert alert--info"},Object(i.b)("div",Object(n.a)({parentName:"div"},{className:"admonition-heading"}),Object(i.b)("h5",{parentName:"div"},Object(i.b)("span",Object(n.a)({parentName:"h5"},{className:"admonition-icon"}),Object(i.b)("svg",Object(n.a)({parentName:"span"},{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"}),Object(i.b)("path",Object(n.a)({parentName:"svg"},{fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"})))),"info")),Object(i.b)("div",Object(n.a)({parentName:"div"},{className:"admonition-content"}),Object(i.b)("p",{parentName:"div"},"This feature is not developed yet"))),Object(i.b)("h2",{id:"ansible-requirements"},"Ansible Requirements"),Object(i.b)("p",null,"First off, if you are not familiar with Ansible-Vault what are you doing with your life? Go do some research. There is a default Ansible config that sets some sane defaults located ",Object(i.b)("a",Object(n.a)({parentName:"p"},{href:"https://github.com/derrickmehaffy/strapi-digitalocean-deploy/blob/main/ansible/ansible.cfg"}),"here"),". I suggest you read through it to understand how it's setup."),Object(i.b)("p",null,"This template uses various roles from Ansible-Galaxy and misc GitHub repos, I suggest you look at the requirements file and review their documentation if you plan to make changes. There is also a ",Object(i.b)("a",Object(n.a)({parentName:"p"},{href:"https://github.com/derrickmehaffy/strapi-digitalocean-deploy/blob/main/ansible/install_requirements.sh"}),"script")," to automatically install them."),Object(i.b)("p",null,"Next you need to make a ",Object(i.b)("inlineCode",{parentName:"p"},"vault_password")," file at the ansible folder root to encrypt/decrypt the ",Object(i.b)("inlineCode",{parentName:"p"},"crypt_vars/*")," files. See the ",Object(i.b)("a",Object(n.a)({parentName:"p"},{href:"https://github.com/derrickmehaffy/strapi-digitalocean-deploy/tree/main/ansible/crypt_vars/example"}),"example folder")," and it's ",Object(i.b)("a",Object(n.a)({parentName:"p"},{href:"https://github.com/derrickmehaffy/strapi-digitalocean-deploy/blob/main/ansible/crypt_vars/example/README.md"}),"README.md")," for some templates and a sample encrypted file. There is a password generation script located ",Object(i.b)("a",Object(n.a)({parentName:"p"},{href:"https://github.com/derrickmehaffy/strapi-digitalocean-deploy/blob/main/ansible/scripts/gen_pwd.sh"}),"here")," for my fellow lazy folks. ",Object(i.b)("strong",{parentName:"p"},"Keep that password safe and handy, if you lose it, back to square one on configuring shit")),Object(i.b)("h2",{id:"ansible-instructions"},"Ansible Instructions"),Object(i.b)("div",{className:"admonition admonition-info alert alert--info"},Object(i.b)("div",Object(n.a)({parentName:"div"},{className:"admonition-heading"}),Object(i.b)("h5",{parentName:"div"},Object(i.b)("span",Object(n.a)({parentName:"h5"},{className:"admonition-icon"}),Object(i.b)("svg",Object(n.a)({parentName:"span"},{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"}),Object(i.b)("path",Object(n.a)({parentName:"svg"},{fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"})))),"info")),Object(i.b)("div",Object(n.a)({parentName:"div"},{className:"admonition-content"}),Object(i.b)("p",{parentName:"div"},"This section is still a WIP"))),Object(i.b)("p",null,"Rough breakdown for those that can't wait:"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},"run the ",Object(i.b)("inlineCode",{parentName:"li"},"./install_requirements.sh")),Object(i.b)("li",{parentName:"ul"},"create your ",Object(i.b)("inlineCode",{parentName:"li"},"vault_password")," file"),Object(i.b)("li",{parentName:"ul"},"configure your vars"),Object(i.b)("li",{parentName:"ul"},"run the ",Object(i.b)("inlineCode",{parentName:"li"},"./run.sh main.yml"))))}c.isMDXComponent=!0},99:function(e,t,a){"use strict";a.d(t,"a",(function(){return p})),a.d(t,"b",(function(){return u}));var n=a(0),r=a.n(n);function i(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function l(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function o(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?l(Object(a),!0).forEach((function(t){i(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):l(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function s(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},i=Object.keys(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var b=r.a.createContext({}),c=function(e){var t=r.a.useContext(b),a=t;return e&&(a="function"==typeof e?e(t):o(o({},t),e)),a},p=function(e){var t=c(e.components);return r.a.createElement(b.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return r.a.createElement(r.a.Fragment,{},t)}},m=r.a.forwardRef((function(e,t){var a=e.components,n=e.mdxType,i=e.originalType,l=e.parentName,b=s(e,["components","mdxType","originalType","parentName"]),p=c(a),m=n,u=p["".concat(l,".").concat(m)]||p[m]||d[m]||i;return a?r.a.createElement(u,o(o({ref:t},b),{},{components:a})):r.a.createElement(u,o({ref:t},b))}));function u(e,t){var a=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var i=a.length,l=new Array(i);l[0]=m;var o={};for(var s in t)hasOwnProperty.call(t,s)&&(o[s]=t[s]);o.originalType=e,o.mdxType="string"==typeof e?e:n,l[1]=o;for(var b=2;b<i;b++)l[b]=a[b];return r.a.createElement.apply(null,l)}return r.a.createElement.apply(null,a)}m.displayName="MDXCreateElement"}}]);